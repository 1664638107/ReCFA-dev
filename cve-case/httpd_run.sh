#! /bin/bash

#current=$(pwd)
recfa_bin=../../ReCFA/bin
#echo $recfa_root
recfa_root=../../ReCFA


if [ -f httpd.dot ]; then
   rm httpd.dot
fi
$recfa_bin/preCFG httpd > httpd.dot

if [ -f httpd.asm ]; then
   rm httpd.asm
fi
objdump -d httpd > httpd.asm



if [[ -f httpd.dot && -f httpd.asm ]]; then
   java -jar $recfa_bin/csfilter.jar httpd.dot httpd.asm httpd.filtered
   echo -e "\n"
fi

$recfa_bin/mutator -r httpd httpd_instru httpd.filtered

./httpd_instru -k start
./httpd_instru -k stop

export LD_LIBRARY_PATH=$recfa_root/lib/:$LD_LIBRARY_PATH

$recfa_bin/folding -r httpd_instru-re
sleep 1s
if [ -f httpd_instru-re_folded ]; then
   $recfa_bin/greedy httpd_instru-re_folded
   sleep 1s
   zstd httpd_instru-re_folded_gr
fi

$recfa_bin/check httpd.asm httpd.dot binfo.httpd httpd.filtered.map httpd_instru-re_folded 2 gcc


