#! /bin/bash

recfa_bin=../../ReCFA/bin
recfa_root=../../ReCFA


if [ -f nginx.dot ]; then
   rm nginx.dot
fi
$recfa_bin/preCFG nginx > nginx.dot

if [ -f nginx.asm ]; then
   rm nginx.asm
fi
objdump -d nginx > nginx.asm



if [[ -f nginx.dot && -f nginx.asm ]]; then
   java -jar $recfa_bin/csfilter.jar nginx.dot nginx.asm nginx.filtered
   echo -e "\n"
fi

$recfa_bin/mutator -r nginx nginx_instru nginx.filtered

./nginx_instru -t
./nginx_instru -q

export LD_LIBRARY_PATH=$recfa_root/lib/:$LD_LIBRARY_PATH

$recfa_bin/folding -r nginx_instru-re

sleep 1s
if [ -f nginx_instru-re_folded ]; then
   $recfa_bin/greedy nginx_instru-re_folded
   sleep 1s
   zstd nginx_instru-re_folded_gr
fi

$recfa_bin/check nginx.asm nginx.dot binfo.nginx nginx.filtered.map nginx_instru-re_folded 1 gcc

